language: cpp

os:
- linux
- osx

compiler:
- gcc
- clang

env:
  matrix:
    - ENABLE_DEBUG=no
    - ENABLE_DEBUG=yes
  global:
    secure: 1x8/zr5nMm3oaGZ9szPrZ5bdXfuKfUcMD0hHH12rR62WzRMv/uK6GGkeHR07+yVrwzD/arwmtpqQJNmFEpg5x2o686bqBMK4ZmXblHwk9AlIl5rYUcClxQkt5+nk01vr24LHz+IVM07h9azFa/8OL2LVLVcfL0XyYWSJ+p5HGAQ=

before_install:
- echo "deb http://llvm.org/apt/precise/ llvm-toolchain-precise main" | sudo tee -a /etc/apt/sources.list
- echo "deb http://llvm.org/apt/precise/ llvm-toolchain-precise-3.6 main" | sudo tee -a /etc/apt/sources.list
- echo "deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu precise main" | sudo tee -a /etc/apt/sources.list
- sudo apt-get update -qq

install:
- sudo apt-get -qq install build-essential libpng-dev libjpeg-dev
- if [ "$CXX" = "g++" ]; then sudo apt-get -qq --allow-unauthenticated install gcc-4.9 g++-4.9; export CXX="g++-4.9" CC="gcc-4.9"; fi
- if [ "$CXX" = "clang++" ]; then sudo apt-get -qq --allow-unauthenticated install clang-3.6; export CXX="clang++-3.6" CC="clang-3.6"; fi
- wget http://www.ffmpeg.org/releases/ffmpeg-2.6.2.tar.bz2
- tar xf ffmpeg-2.6.2.tar.bz2
- cd ffmpeg-2.6.2 && ./configure --prefix=/usr --disable-static --enable-shared --disable-everything --disable-avdevice --disable-doc --disable-htmlpages --disable-manpages --disable-programs --disable-encoders --disable-muxers --disable-decoders --enable-swscale --disable-yasm --enable-protocol=file --enable-protocol=http --enable-iconv  && make -j4 && sudo make install
- cd ..

script:
- cmake -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DENABLE_STATIC=ON -DENABLE_SHARED=ON -DENABLE_GIO=ON -DENABLE_THUMBNAILER=ON .
- make -j4
- ls -la /home/travis/build/dirkvdb/ffmpegthumbnailer/test/
- stat /home/travis/build/dirkvdb/ffmpegthumbnailer/test/test_sample.flv
- CTEST_OUTPUT_ON_FAILURE=1 make test

addons:
  coverity_scan:
    project:
      name: "dirkvdb/ffmpegthumbnailer"
      description: "Build submitted via Travis CI"
    notification_email: dirk.vdb@gmail.com
    build_command_prepend: "cmake . -DCMAKE_CXX_COMPILE=g++-4.9"
    build_command: "make -j4"
    branch_pattern: coverity_scan